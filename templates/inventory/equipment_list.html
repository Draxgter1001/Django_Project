{% extends 'inventory/base.html' %}

{% load static %}

{% block title %}Equipment List{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'equipmentList.css' %}">
{% endblock %}

{% block content %}
<div class="content">
    <h1>Equipment List</h1>
    <button class="filter-button">Filter list</button>
    <table class="equipment-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Availability</th>
                <th>Quantity</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody>
            {% for equipment in equipment_list %}
            <tr data-equipment-id="{{ equipment.id }}" onclick="showDetailsModal('{{ equipment.id }}')">
                <td>{{ equipment.name }}</td>
                <td>{{ equipment.type }}</td>
                <td>{{ equipment.availability|yesno:"Available, Not Available" }}</td>
                <td>{{ equipment.quantity }}</td>
                <td>{{ equipment.location }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5">No equipment found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Details Modal -->
<div id="equipmentDetailsModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="equipmentDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="equipmentDetailsModalLabel">Equipment Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="equipmentDetails">
                <!-- Equipment details will be dynamically inserted here -->
                <div>Details for Equipment ID: <span id="modal-equipment-id"></span></div>
                <label for="quantity-required">Quantity to reserve:</label>
                <input type="number" id="quantity-required" name="quantity" min="1" placeholder="Enter quantity">
                <button type="button" id="reserve-button" class="btn btn-primary" onclick="reserveEquipment()">Reserve</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div id="filterModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Filter equipment</h2>
        <form method="get" action="{% url 'inventory:equipment_list' %}">
            <label for="equipment-name">Equipment name:</label>
            <input type="text" id="equipment-name" name="name" placeholder="Enter equipment name">
            <label for="type">Type:</label>
            <select id="type" name="type">
                <option value="">Select type</option>
                {% for type in equipment_types %}
                <option value="{{ type }}">{{ type }}</option>
                {% endfor %}
            </select>
            <label for="availability">Availability:</label>
            <select id="availability" name="availability">
                <option value="">Select availability</option>
                <option value="Available">Available</option>
                <option value="Not Available">Not Available</option>
            </select>
            <label for="location">Location:</label>
            <select id="location" name="location">
                <option value="">Select location</option>
                {% for location in equipment_locations %}
                <option value="{{ location }}">{{ location }}</option>
                {% endfor %}
            </select>
            <button type="submit" id="applyFilters">Apply filters</button>
        </form>
    </div>
</div>

<script>
var modal = document.getElementById("filterModal");
var btn = document.querySelector(".filter-button");
var span = document.getElementsByClassName("close")[0];

var detailsModal = document.getElementById("equipmentDetailsModal");
var detailsSpan = detailsModal.getElementsByClassName("close")[0];

btn.onclick = function() {
    modal.style.display = "block";
};

span.onclick = function() {
    modal.style.display = "none";
};

window.onclick = function(event) {
    if (event.target === modal || event.target === detailsModal) {
        modal.style.display = "none";
        detailsModal.style.display = "none";
    }
};

function showDetailsModal(equipmentId) {
    document.getElementById('modal-equipment-id').textContent = equipmentId;
    detailsModal.style.display = 'block';
}

function reserveEquipment() {
    var equipmentId = document.getElementById('modal-equipment-id').textContent;
    var quantityRequired = document.getElementById('quantity-required').value;

    if (!quantityRequired || quantityRequired <= 0) {
        alert('Please enter a valid quantity.');
        return;
    }

    // AJAX request to reserve equipment
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '{% url "inventory:reserve_equipment" %}', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');  // CSRF token from Django template
    xhr.onload = function () {
        if (xhr.status >= 200 && xhr.status < 300) {
            console.log('Reservation successful', xhr.responseText);
            detailsModal.style.display = 'none';
        } else {
            console.log('The request failed', xhr.responseText);
            alert('Failed to reserve. Please try again.');
        }
    };
    xhr.send('equipment_id=' + equipmentId + '&quantity_required=' + quantityRequired);
}

document.getElementById('applyFilters').addEventListener('click', function(event) {
    event.preventDefault();  // Prevent the form from submitting traditionally

    // Get filter values
    var nameFilter = document.getElementById('equipment-name').value.toLowerCase();
    var typeFilter = document.getElementById('type').value;
    var availabilityFilter = document.getElementById('availability').value;
    var locationFilter = document.getElementById('location').value;

    var table = document.querySelector('.equipment-table tbody');
    var rows = table.querySelectorAll('tr');

    // Filter rows
    rows.forEach(row => {
        var name = row.cells[0].textContent.toLowerCase();
        var type = row.cells[1].textContent;
        var availability = row.cells[2].textContent.trim();
        var location = row.cells[4].textContent;

        // Check each row if it matches all the filters
        var nameMatch = nameFilter === "" || name.includes(nameFilter);
        var typeMatch = typeFilter === "" || type === typeFilter;
        var availabilityMatch = availabilityFilter === "" || availability.includes(availabilityFilter);
        var locationMatch = locationFilter === "" || location.includes(locationFilter);

        if (nameMatch && typeMatch && availabilityMatch && locationMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    // Close the modal after applying filters
    modal.style.display = 'none';
});

detailsSpan.onclick = function() {
    detailsModal.style.display = 'none';
};

</script>
{% endblock %}
